# =============================================================================
# STREAM SERVICES ONLY - For standalone stream server
# =============================================================================
# Usage: docker-compose -f docker-compose.stream.yml up -d
# =============================================================================

services:
  mediamtx:
    profiles: ["stream", "stream-cloud", "mediamtx-cloud", "all", "appstack"]
    image: bluenviron/mediamtx:latest-ffmpeg
    container_name: nayarta-stream
    restart: unless-stopped
    ports:
      - "8554:8554"   # RTSP
      - "8889:8889"   # WebRTC
      - "8189:8189/tcp"   # WebRTC Local TCP
      - "8189:8189/udp"   # WebRTC Local UDP
      - "8888:8888"   # HLS
      - "9999:9997"   # API
      # - "9998:9998"   # Metrics
    volumes:
      - ${HOST_PROJECT_ROOT:-.}/stream/config/mediamtx.yml:/mediamtx.yml:ro
      - ${HOST_PROJECT_ROOT:-.}/stream/data/mediamtx/hls:/hls:rw
    environment:
      - MTX_CONF=/mediamtx.yml
    networks:
      - nayarta-network
    labels:
      - "com.project.name=nayarta"
      - "com.project.profile=stream"

  mediamtx-nvr:
    profiles: ["stream","stream-nvr", "mediamtx-nvr", "all", "appstack"]
    image: bluenviron/mediamtx:latest-ffmpeg
    container_name: nayarta-stream-nvr
    restart: unless-stopped
    ports:
      - "8555:8554"   # RTSP
      - "9997:9997"   # API
    #   # - "9998:9998"   # Metrics
    volumes:
      - ${HOST_PROJECT_ROOT:-.}/stream/config/mediamtx-local.yml:/mediamtx.yml:ro
      - ${HOST_PROJECT_ROOT:-.}/stream/data/mediamtx/hls:/hls:rw
    environment:
      - MTX_CONF=/mediamtx.yml
    networks:
      - nayarta-network
    labels:
      - "com.project.name=nayarta"
      - "com.project.profile=stream-nvr"
  
  mediamtx-cam:
    profiles: ["stream-camera",]
    image: bluenviron/mediamtx:latest-ffmpeg
    container_name: nayarta-camera
    # ports:
    #   - "8556:8554"   # RTSP
    restart: unless-stopped
    networks:
      - nayarta-network
    labels:
      - "com.project.name=nayarta"
      - "com.project.profile=stream-camera"

  stream-test-cam1:
    image: linuxserver/ffmpeg
    profiles: ["stream-camera", "cam1"]
    container_name: stream-test-cam1
    command: -re -stream_loop -1 -fflags +genpts -i /videos/sample1.mp4 -vf scale=640:480 -c:v libx264 -preset ultrafast -tune zerolatency -b:v 1000k -maxrate 1000k -bufsize 2000k -c:a aac -ar 44100 -use_wallclock_as_timestamps 1 -rtsp_transport tcp -f rtsp rtsp://mediamtx-cam:8554/f6075d78-1e29-4dcb-ad28-e08117f920e4
    volumes:
      - ${HOST_PROJECT_ROOT:-.}/stream/video:/videos
    networks:
      - nayarta-network
    labels:
      - "com.project.name=nayarta"
      - "com.project.profile=stream-camera"
      - "com.project.profile.cam1=true"

  stream-test-cam2:
    image: linuxserver/ffmpeg
    profiles: ["stream-camera", "cam2"]
    container_name: stream-test-cam2
    command: -re -stream_loop -1 -fflags +genpts -i /videos/sample2.mp4 -vf scale=640:480 -c:v libx264 -preset ultrafast -tune zerolatency -b:v 1000k -maxrate 1000k -bufsize 2000k -c:a aac -ar 44100 -use_wallclock_as_timestamps 1 -rtsp_transport tcp -f rtsp rtsp://mediamtx-cam:8554/cam2
    volumes:
      - ${HOST_PROJECT_ROOT:-.}/stream/video:/videos
    networks:
      - nayarta-network
    labels:
      - "com.project.name=nayarta"
      - "com.project.profile=stream-camera"
      - "com.project.profile.cam2=true"

  stream-test-cam3:
    image: linuxserver/ffmpeg
    profiles: ["stream-camera", "cam3"]
    container_name: stream-test-cam3
    command: -re -stream_loop -1 -fflags +genpts -i /videos/sample1.mp4 -vf scale=640:480 -c:v libx264 -preset ultrafast -tune zerolatency -b:v 1000k -maxrate 1000k -bufsize 2000k -c:a aac -ar 44100 -use_wallclock_as_timestamps 1 -rtsp_transport tcp -f rtsp rtsp://mediamtx-cam:8554/cam3
    volumes:
      - ${HOST_PROJECT_ROOT:-.}/stream/video:/videos
    networks:
      - nayarta-network
    labels:
      - "com.project.name=nayarta"
      - "com.project.profile=stream-camera"
      - "com.project.profile.cam3=true"

  stream-test-cam4:
    image: linuxserver/ffmpeg
    profiles: ["stream-camera", "cam4"]
    container_name: stream-test-cam4
    command: -re -stream_loop -1 -fflags +genpts -i /videos/sample2.mp4 -vf scale=640:480 -c:v libx264 -preset ultrafast -tune zerolatency -b:v 1000k -maxrate 1000k -bufsize 2000k -c:a aac -ar 44100 -use_wallclock_as_timestamps 1 -rtsp_transport tcp -f rtsp rtsp://mediamtx-cam:8554/cam4
    volumes:
      - ${HOST_PROJECT_ROOT:-.}/stream/video:/videos
    networks:
      - nayarta-network
    labels:
      - "com.project.name=nayarta"
      - "com.project.profile=stream-camera"
      - "com.project.profile.cam4=true"

  emqx:
    profiles: ["mqtt", "all", "appstack"]
    image: emqx/emqx:5.7.1
    container_name: nayarta-mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"    # MQTT TCP
      - "8083:8083"    # MQTT WebSocket
      - "8883:8883"    # MQTT SSL
      - "8084:8084"    # MQTT WebSocket SSL
      - "18083:18083"  # Dashboard
    environment:
      # Dashboard Admin User
      - EMQX_DASHBOARD__DEFAULT_USERNAME=${EMQX_DASHBOARD_USER:-root}
      - EMQX_DASHBOARD__DEFAULT_PASSWORD=${EMQX_DASHBOARD_PASS:-nayarta_root_password}
      
      # Authentication Configuration
      # - EMQX_AUTHENTICATION__1__BACKEND=built_in_database
      # - EMQX_AUTHENTICATION__1__MECHANISM=password_based
      # - EMQX_AUTHENTICATION__1__PASSWORD_HASH_ALGORITHM__NAME=sha256
      # - EMQX_AUTHENTICATION__1__PASSWORD_HASH_ALGORITHM__SALT_POSITION=suffix
      # - EMQX_AUTHENTICATION__1__ENABLE=true
      
      # Listener Configuration - DISABLE anonymous
      # - EMQX_LISTENERS__TCP__DEFAULT__ENABLE_AUTHN=true
      # - EMQX_LISTENERS__TCP__DEFAULT__MAX_CONNECTIONS=1024000
      # - EMQX_LISTENERS__WS__DEFAULT__ENABLE_AUTHN=true
      # - EMQX_LISTENERS__SSL__DEFAULT__ENABLE_AUTHN=true
      # - EMQX_LISTENERS__WSS__DEFAULT__ENABLE_AUTHN=true
      
      # Security - Force authentication
      - EMQX_ALLOW_ANONYMOUS=false
      
      # Node configuration
      - EMQX_NODE_NAME=emqx@nayarta-mqtt
      - EMQX_CLUSTER__DISCOVERY_STRATEGY=static
      - EMQX_CLUSTER__STATIC__SEEDS=[emqx@nayarta-mqtt]
      
      # Logging
      - EMQX_LOG__CONSOLE__LEVEL=info
    volumes:
      - emqx_data:/opt/emqx/data:rw
      - emqx_logs:/opt/emqx/log:rw
    networks:
      - nayarta-network
    healthcheck:
      test: ["CMD", "sh", "-c", "grep -q 075B /proc/net/tcp"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.project.name=nayarta"
      - "com.project.profile=mqtt"

  # emqx-init:
  #   profiles: ["stream", "mqtt", "all", "appstack"]
  #   image: curlimages/curl:latest
  #   container_name: nayarta-mqtt-init
  #   depends_on: 
  #     emqx:
  #       condition: service_healthy
  #   env_file:
  #     - .env
  #   environment:
  #     - EMQX_DASHBOARD_USER=${EMQX_DASHBOARD_USER}
  #     - EMQX_DASHBOARD_PASS=${EMQX_DASHBOARD_PASS}
  #     - MQTT_USER=${MQTT_USER}
  #     - MQTT_USER_PASS=${MQTT_PASSWORD}
  #   networks:
  #     - nayarta-network
  #   entrypoint: ["/bin/sh", "-c"]
  #   command:
  #     - |
  #       echo "⏳ Waiting for EMQX API to be ready..."
  #       sleep 15
        
  #       echo "Creating MQTT user: $${MQTT_USER}"
  #       curl -s -u "$${EMQX_DASHBOARD_USER}:$${EMQX_DASHBOARD_PASS}" \
  #         -X POST "http://nayarta-mqtt:18083/api/v5/authentication/password_based:built_in_database/users" \
  #         -H "Content-Type: application/json" \
  #         -d "{\"user_id\":\"$${MQTT_USER}\",\"password\":\"$${MQTT_USER_PASS}\"}" \
  #         | grep -q '"code":0' \
  #         && echo "✅ MQTT user '$${MQTT_USER}' created successfully!" \
  #         || echo "⚠️  MQTT user may already exist or failed to create."
  #   restart: "no"

volumes:
  mediamtx_data:
    name: nayarta_mediamtx_data
  mediamtx_logs:
    name: nayarta_mediamtx_logs
  emqx_data:
    name: nayarta_emqx_data
  emqx_logs:
    name: nayarta_emqx_logs
