# =============================================================================
# PostgreSQL Configuration for Nayarta VMS
# =============================================================================
# This configuration is optimized for production use with Docker
# All line endings are LF (Unix format) for cross-platform compatibility
# =============================================================================

# -----------------------------------------------------------------------------
# CONNECTION SETTINGS
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 100
superuser_reserved_connections = 3
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# -----------------------------------------------------------------------------
# MEMORY SETTINGS
# -----------------------------------------------------------------------------
# Shared memory buffers (25% of RAM recommended, but max 8GB)
shared_buffers = 256MB

# Effective cache size (50-75% of total RAM)
effective_cache_size = 1GB

# Work memory per operation (for sorts, hashes, etc.)
work_mem = 4MB

# Maintenance work memory (for VACUUM, CREATE INDEX, etc.)
maintenance_work_mem = 64MB

# Maximum memory for temp files (0 = unlimited)
temp_file_limit = 0

# -----------------------------------------------------------------------------
# WRITE-AHEAD LOGGING (WAL)
# -----------------------------------------------------------------------------
# WAL level: minimal, replica, or logical
wal_level = replica

# Maximum size of WAL files
max_wal_size = 1GB

# Minimum size of WAL files
min_wal_size = 80MB

# Target for checkpoint completion (0.0 - 1.0)
checkpoint_completion_target = 0.9

# WAL buffers (typically 16MB is sufficient)
wal_buffers = 16MB

# Checkpoint timeout
checkpoint_timeout = 10min

# -----------------------------------------------------------------------------
# QUERY PLANNER
# -----------------------------------------------------------------------------
# Random page cost (lower for SSD, higher for HDD)
# 1.1 is good for SSD, 4.0 for HDD
random_page_cost = 1.1

# Effective I/O concurrency (number of concurrent I/O operations)
effective_io_concurrency = 200

# Default statistics target
default_statistics_target = 100

# -----------------------------------------------------------------------------
# LOGGING
# -----------------------------------------------------------------------------
# Log destination: stderr, csvlog, syslog, or eventlog (Windows)
log_destination = 'stderr'

# Enable logging collector
logging_collector = on

# Log directory (relative to data directory)
log_directory = 'log'

# Log filename pattern
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# Log rotation
log_rotation_age = 1d
log_rotation_size = 100MB

# Log slow queries (milliseconds, 0 = disabled)
log_min_duration_statement = 1000

# Log line prefix
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# What to log
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
log_autovacuum_min_duration = 0
log_error_verbosity = default

# -----------------------------------------------------------------------------
# LOCALE AND FORMATTING
# -----------------------------------------------------------------------------
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# -----------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
# -----------------------------------------------------------------------------
# Statement timeout (0 = disabled)
statement_timeout = 0

# Lock timeout (0 = disabled)
lock_timeout = 0

# Idle in transaction timeout (0 = disabled)
idle_in_transaction_session_timeout = 0

# -----------------------------------------------------------------------------
# VACUUM AND AUTOVACUUM
# -----------------------------------------------------------------------------
# Enable autovacuum
autovacuum = on

# Autovacuum scale factor
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1

# Autovacuum max workers
autovacuum_max_workers = 3

# Autovacuum naptime
autovacuum_naptime = 1min

# -----------------------------------------------------------------------------
# QUERY TUNING
# -----------------------------------------------------------------------------
# Constraint exclusion
constraint_exclusion = partition

# Cursor tuple fraction
cursor_tuple_fraction = 0.1

# From collapse limit
from_collapse_limit = 8

# Join collapse limit
join_collapse_limit = 8

# -----------------------------------------------------------------------------
# EXTENSIONS AND PLUGINS
# -----------------------------------------------------------------------------
# Enable pgvector extension (if installed)
# shared_preload_libraries = 'vector'

# -----------------------------------------------------------------------------
# SECURITY
# -----------------------------------------------------------------------------
# Password encryption
password_encryption = scram-sha-256

# SSL (configure if needed)
# ssl = off
# ssl_cert_file = 'server.crt'
# ssl_key_file = 'server.key'

# -----------------------------------------------------------------------------
# HBA FILE
# -----------------------------------------------------------------------------
# Path to pg_hba.conf file
hba_file = '/etc/postgresql/pg_hba.conf'

# -----------------------------------------------------------------------------
# ADDITIONAL SETTINGS
# -----------------------------------------------------------------------------
# Maximum number of prepared transactions
max_prepared_transactions = 0

# Maximum number of locks per transaction
max_locks_per_transaction = 64

# Maximum number of predicate locks per transaction
max_pred_locks_per_transaction = 64

# Deadlock timeout
deadlock_timeout = 1s

# -----------------------------------------------------------------------------
# END OF CONFIGURATION
# -----------------------------------------------------------------------------
